#!/usr/bin/env ruby

# encoding: utf-8

# usage: run <server-json>
# runs the server

require 'json'
require 'time'

STDOUT.sync = true
STDIN.sync = true

server_json = ARGV.first
HUMAN_FRIENDLY = ARGV.include? "-h"
bin = File.expand_path File.join(__FILE__, '..')

server_settings = JSON.parse(File.read(server_json))
system "#{bin}/prepare #{server_json}"

ram_min, ram_max = server_settings['ram']['min'], server_settings['ram']['max']

# Events:
# started
# stopping
# player_connected      { username: '..' }
# player_disconnected
# chatted
# opped
# deopped
# whitelist_added
# whitelist_removed
# banned
# pardoned
# info
# warning
# critical

class LogProcessor
  def initialize pid
    @pid = pid
    @listing = false
  end

  def process_line line
    line = line.force_encoding('ISO-8859-1').
              gsub(/\u001b\[(m|\d+;\dm)?/, ''). # strip color sequences out
              gsub(/(>)?\r/, '').
              gsub(/[\d:]+\s\[[A-Z]+\]\s/, '').strip  # strip message prefix

    case line
    when /^<(\w+)> (.*)$/
      event 'chat', nick: $1, msg: $2

    when /Done \(/
      event 'started'

    when /^Stopping server$/
      event 'stopping'

    when /^(\w+).*logged in with entity id/
      event 'player_connected', auth: 'mojang', uid: $1

    when /^(\w+) lost connection: (.*)$/
      event 'player_disconnected', auth: 'mojang', uid: $1, reason: $2

    when /^Connected players:(.*)$/
      @players = $1.split(',').map(&:strip)
      event 'players_list', auth: 'mojang', uids: @players

    when /^(\w+): Added (\w+) to white-list/
      settings_changed $1, 'whitelist_add', $2
    when /^(\w+): Removed (\w+) from white-list/
      settings_changed $1, 'whitelist_remove', $2
    when /^(\w+): Opping (\w+)/
      settings_changed $1, 'ops_add', $2
    when /^(\w+): De-opping (\w+)/
      settings_changed $1, 'ops_remove', $2
    when /^(\w+): Banning (\w+)/
      settings_changed $1, 'blacklist_add', $2
    when /^(\w+): Pardoning (\w+)/
      settings_changed $1, 'blacklist_remove', $2

    when /FAILED TO BIND TO PORT!/
      event 'fatal_error'
      Process.kill :TERM, @pid

    else
      event 'info', msg: line.strip
    end

    def settings_changed actor, key, value
      event 'settings_changed',
        actor: actor,
          key: key,
          value: value.to_s
    end
  end

  def readable type, options={}
    "#{Time.now.utc.strftime('%Y-%b-%d %H:%M:%S')} [#{type}] " +
      options.map{|k,v| "#{k}=#{v.include?(' ') ? ("\"" + v + "\"") : v}"}.join(' ')
  end

  def json type, options={}
    args = {ts: Time.now.utc.iso8601, event: type, pid: @pid }.merge(options)
    JSON.dump(args)
  end

  def event type, options = {}
    line = if HUMAN_FRIENDLY
      readable type, options
    else
      json type, options
    end
    puts line
  end
end

IO.popen(["java",
            "-Xms#{ram_min}M", "-Xmx#{ram_max}M",
            "-jar", "Tekkit.jar",
            "nogui", :err => [:child, :out]]) do |io|
  begin
    processor = LogProcessor.new(io.pid)
    while true
      processor.process_line io.readline
    end
  rescue EOFError
  end
end
